<!DOCTYPE html>
<html>
<head>
<title>HugeMaze</title>
<meta charset="UTF-8">
<style>
body {
    margin: 0;
    padding: 0;
}

main {
    margin: 0;
    padding: 0;
}

main>header {
    width: 100%;
    margin: 0;
    padding: 0 20px;
    position: sticky;
    top: 0;
    background: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
}

main>header>.item {
    margin-right: 20px;
}

#maze {
    padding: 20px;
}

.pixelated {
    -ms-interpolation-mode: nearest-neighbor;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: -moz-crisp-edges;
    image-rendering: -o-crisp-edges;
    image-rendering: pixelated;
}
</style>
<script>
let player = { x: 1, y: 1 }

const playerColor = '#00FF00FF';
const trackColor  = '#CFFFCFFF';
const startColor  = '#0000FFFF';
const goalColor   = '#FF0000FF';

const scale = 4;
function main() {
    console.log('100');
    let canvas = document.getElementById('maze').getElementsByTagName('canvas')[0];
    let context = canvas.getContext('2d');

    function drawCell(context, x, y, style) {
        context.fillStyle = style.substr(0, 7);
        context.fillRect(x * scale, y * scale, scale, scale);
    }

    let image = new Image();
    image.src = './img/maze-1023x1023.png';
    image.addEventListener('load', () => {
        context.mozImageSmoothingEnabled = false;
        context.webkitImageSmoothingEnabled = false;
        context.msImageSmoothingEnabled = false;
        context.imageSmoothingEnabled = false;
        context.drawImage(image, 0, 0, image.width, image.height, 0, 0, image.width * scale, image.height * scale);

        let maze = context.getImageData(0, 0, image.width, image.height);

        function move(dx, dy) {
            const newX = player.x + dx;
            const newY = player.y + dy;
            const newPixelColor = toHexColor(getPixel(maze, newX * scale, newY * scale));

            if (newPixelColor === '#000000FF') {
                return;
            }

            const oldPixelColor = toHexColor(getPixel(maze, player.x * scale, player.y * scale));

            if (oldPixelColor === startColor || oldPixelColor === goalColor) {
                drawCell(context, player.x, player.y, oldPixelColor);
            } else {
                drawCell(context, player.x, player.y, trackColor);
            }

            player.x = newX;
            player.y = newY;
            drawCell(context, player.x, player.y, playerColor);
        }

        drawCell(context, player.x, player.y, playerColor);

        document.addEventListener('keydown', (event) => {
            let dx = 0;
            let dy = 0;

            if (event.key == 'ArrowUp') {
                dy = -1;
            } else if (event.key == 'ArrowDown') {
                dy = 1;
            } else if (event.key == 'ArrowLeft') {
                dx = -1;
            } else if (event.key == 'ArrowRight') {
                dx = 1;
            } else {
                return;
            }

            event.preventDefault();

            move(dx, dy);
        });

        document.getElementById('left-button').onclick = () => {
            move(-1, 0);
        };
        document.getElementById('up-button').onclick = () => {
            move(0, -1);
        };
        document.getElementById('down-button').onclick = () => {
            move(0, 1);
        };
        document.getElementById('right-button').onclick = () => {
            move(1, 0);
        };
    }, false);
}

function getPixel(image, x, y) {
    const offset = (y * image.width + x) * 4;
    const r = image.data[offset + 0];
    const g = image.data[offset + 1];
    const b = image.data[offset + 2];
    const a = image.data[offset + 3];
    return [r, g, b, a];
}

function toHexColor(pixel) {
    return (
        '#'
        + ('0' + pixel[0].toString(16)).substr(-2)
        + ('0' + pixel[1].toString(16)).substr(-2)
        + ('0' + pixel[2].toString(16)).substr(-2)
        + ('0' + pixel[3].toString(16)).substr(-2)
    ).toUpperCase();
}
</script>
</head>
<body onload="main()">
<main>
    <header>
        <h1 class="item">HugeMaze</h1>
        <div class="item">
            <button id="left-button">←</button>
            <button id="up-button">↑</button>
            <button id="down-button">↓</button>
            <button id="right-button">→</button>
        </div>
        <div class="item"><span style="color: #00FF00;">■</span>: PLAYER, </span><span style="color: #0000FF;">■</span>: START, <span style="color: #FF0000;">■</span>: GOAL</div>
        <div class="item">made with <a href="https://github.com/koher/makemaze">"makemaze"</a></div>
    </header>
    <div id="maze">
        <canvas class="pixelated" width="4092" height="4092"></canvas>
    </div>
</main>
</body>
</html>
